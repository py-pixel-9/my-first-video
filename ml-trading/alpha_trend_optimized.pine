// Alpha Trend Master - Optimized Strategy v2.0
// Base: ATR Trailing Stop (keyvalue=50, ATR5) + EMA(1000) Filter
// Optimized: SL 2% / TP 10% (RR 1:5) | Risk-based position sizing
// Timeframe: M30 | Pair: BTCUSDT Perpetual
// Python Backtest: ALL 5 YEARS PROFITABLE (2022-2026)
// PF 1.77, MDD 11.2%, 54 trades, $8,585 (Risk 2%)

//@version=5
strategy("Alpha Trend Opt v2.0",
     overlay=true,
     initial_capital=10000,
     default_qty_type=strategy.percent_of_equity,
     default_qty_value=100,
     commission_type=strategy.commission.percent,
     commission_value=0.06,
     slippage=1,
     currency=currency.USD,
     process_orders_on_close=false,
     calc_on_every_tick=false,
     max_bars_back=5000)

// ============================================================
// INPUTS
// ============================================================
grp_core = "Core: ATR Trailing Stop"
keyvalue    = input.float(50.0, "Key Value (ATR Multiplier)", minval=1, step=1, group=grp_core,
              tooltip="Trailing stop distance = keyvalue * ATR. Higher = wider stop, fewer signals")
atr_period  = input.int(5, "ATR Period", minval=1, group=grp_core)

grp_filter = "Filter: EMA Trend"
ema_period  = input.int(1000, "EMA Period", minval=10, group=grp_filter,
              tooltip="M30: 1000 (~20 days), 1H: 500, 2H: 250")
use_ema     = input.bool(true, "Use EMA Filter", group=grp_filter)

grp_risk = "Risk Management"
sl_pct      = input.float(2.0, "SL % (Stop Loss)", minval=0.1, step=0.1, group=grp_risk)
tp_pct      = input.float(10.0, "TP % (Take Profit)", minval=0.1, step=0.1, group=grp_risk)
risk_pct    = input.float(2.0, "Risk % per Trade", minval=0.1, step=0.5, group=grp_risk,
              tooltip="Percentage of equity risked per trade. 2%=safe, 3%=moderate, 5%=aggressive")

grp_alert = "Alerts (Python Bot)"
use_alerts  = input.bool(true, "Enable Alert Messages", group=grp_alert)

// ============================================================
// ATR TRAILING STOP (Wilder's ATR + Trailing Logic)
// ============================================================

// ATR calculation (RMA / Wilder's smoothing)
atr_val = ta.atr(atr_period)

// nLoss = keyvalue * ATR
nLoss = keyvalue * atr_val

// ATR Trailing Stop
var float xATRTrailingStop = na

iff_1 = close > nz(xATRTrailingStop[1], 0) ? close - nLoss : close + nLoss
iff_2 = close < nz(xATRTrailingStop[1], 0) and close[1] < nz(xATRTrailingStop[1], 0) ? math.min(nz(xATRTrailingStop[1]), close + nLoss) : iff_1
xATRTrailingStop := close > nz(xATRTrailingStop[1], 0) and close[1] > nz(xATRTrailingStop[1], 0) ? math.max(nz(xATRTrailingStop[1]), close - nLoss) : iff_2

// Position detection (above/below trailing stop)
var int pos = 0
iff_3 = close[1] < nz(xATRTrailingStop[1], 0) and close > nz(xATRTrailingStop[1], 0) ? 1 : -1
pos := close[1] > nz(xATRTrailingStop[1], 0) and close < nz(xATRTrailingStop[1], 0) ? -1 : iff_3

// Cross signals (confirmed bar only)
buy_cross  = ta.crossover(close, xATRTrailingStop)
sell_cross = ta.crossunder(close, xATRTrailingStop)

// ============================================================
// EMA TREND FILTER
// ============================================================
ema_line = ta.ema(close, ema_period)
ema_bull = not use_ema or close > ema_line
ema_bear = not use_ema or close < ema_line

// ============================================================
// ENTRY CONDITIONS (barstate.isconfirmed prevents repainting)
// ============================================================
long_signal  = buy_cross and ema_bull and barstate.isconfirmed
short_signal = sell_cross and ema_bear and barstate.isconfirmed

// ============================================================
// POSITION SIZING (Risk-based)
// ============================================================
calc_qty(float entry_price) =>
    sl_distance = entry_price * (sl_pct / 100.0)
    risk_amount = strategy.equity * (risk_pct / 100.0)
    qty = risk_amount / sl_distance
    qty

// ============================================================
// TRADE EXECUTION
// ============================================================
var float entry_price = na
var float sl_price = na
var float tp_price = na

// Close existing position before opening opposite
if long_signal and strategy.position_size < 0
    strategy.close("Short", comment="Close Short -> Long")
if short_signal and strategy.position_size > 0
    strategy.close("Long", comment="Close Long -> Short")

// LONG Entry
if long_signal and strategy.position_size <= 0
    entry_price := close
    sl_price := close * (1 - sl_pct / 100.0)
    tp_price := close * (1 + tp_pct / 100.0)
    qty = calc_qty(close)

    strategy.entry("Long", strategy.long, qty=qty, comment="LONG")
    strategy.exit("Long Exit", "Long", stop=sl_price, limit=tp_price,
                  comment_profit="TP", comment_loss="SL")

    if use_alerts
        alert_msg = '{"signal":"LONG","entry":' + str.tostring(close, "#.##") + ',"sl":' + str.tostring(sl_price, "#.##") + ',"tp":' + str.tostring(tp_price, "#.##") + ',"atr":' + str.tostring(atr_val, "#.##") + ',"trailing_stop":' + str.tostring(xATRTrailingStop, "#.##") + ',"qty":' + str.tostring(qty, "#.####") + ',"risk_pct":' + str.tostring(risk_pct) + '}'
        alert(alert_msg, alert.freq_once_per_bar_close)

// SHORT Entry
if short_signal and strategy.position_size >= 0
    entry_price := close
    sl_price := close * (1 + sl_pct / 100.0)
    tp_price := close * (1 - tp_pct / 100.0)
    qty = calc_qty(close)

    strategy.entry("Short", strategy.short, qty=qty, comment="SHORT")
    strategy.exit("Short Exit", "Short", stop=sl_price, limit=tp_price,
                  comment_profit="TP", comment_loss="SL")

    if use_alerts
        alert_msg = '{"signal":"SHORT","entry":' + str.tostring(close, "#.##") + ',"sl":' + str.tostring(sl_price, "#.##") + ',"tp":' + str.tostring(tp_price, "#.##") + ',"atr":' + str.tostring(atr_val, "#.##") + ',"trailing_stop":' + str.tostring(xATRTrailingStop, "#.##") + ',"qty":' + str.tostring(qty, "#.####") + ',"risk_pct":' + str.tostring(risk_pct) + '}'
        alert(alert_msg, alert.freq_once_per_bar_close)

// ============================================================
// PLOTTING
// ============================================================

// ATR Trailing Stop line (main indicator)
ts_color = pos == 1 ? color.new(#26a69a, 0) : color.new(#ef5350, 0)
plot(xATRTrailingStop, "ATR Trailing Stop", color=ts_color, linewidth=2, style=plot.style_line)

// EMA line
plot(use_ema ? ema_line : na, "EMA Filter", color=color.new(#ffa726, 40), linewidth=1)

// Entry signals
plotshape(long_signal, "Long Signal", shape.triangleup, location.belowbar,
          color.new(#26a69a, 0), size=size.small)
plotshape(short_signal, "Short Signal", shape.triangledown, location.abovebar,
          color.new(#ef5350, 0), size=size.small)

// SL/TP levels (only when in position)
plot(strategy.position_size > 0 ? sl_price : na, "Long SL",
     color=color.new(#ef5350, 50), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size > 0 ? tp_price : na, "Long TP",
     color=color.new(#26a69a, 50), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 ? sl_price : na, "Short SL",
     color=color.new(#ef5350, 50), style=plot.style_linebr, linewidth=1)
plot(strategy.position_size < 0 ? tp_price : na, "Short TP",
     color=color.new(#26a69a, 50), style=plot.style_linebr, linewidth=1)

// Background: position direction
bgcolor(strategy.position_size > 0 ? color.new(#26a69a, 95) : strategy.position_size < 0 ? color.new(#ef5350, 95) : na, title="Position BG")

// ============================================================
// INFO TABLE
// ============================================================
var table info_table = table.new(position.top_right, 2, 10,
     bgcolor=color.new(#1e222d, 10), frame_color=color.new(#363c4e, 0),
     frame_width=1, border_color=color.new(#363c4e, 0), border_width=1)

if barstate.islast
    table.cell(info_table, 0, 0, "Strategy", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 0, "Alpha Trend Opt v2.0", text_color=color.white, text_size=size.small)

    table.cell(info_table, 0, 1, "KeyValue", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 1, str.tostring(keyvalue) + " x ATR(" + str.tostring(atr_period) + ")", text_color=color.white, text_size=size.small)

    table.cell(info_table, 0, 2, "ATR", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 2, str.tostring(atr_val, "#.##"), text_color=color.white, text_size=size.small)

    table.cell(info_table, 0, 3, "Trailing Stop", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 3, str.tostring(xATRTrailingStop, "#.##"), text_color=pos == 1 ? color.green : color.red, text_size=size.small)

    table.cell(info_table, 0, 4, "EMA(" + str.tostring(ema_period) + ")", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 4, str.tostring(ema_line, "#.##"), text_color=close > ema_line ? color.green : color.red, text_size=size.small)

    table.cell(info_table, 0, 5, "Trend", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 5, pos == 1 ? "BULLISH" : "BEARISH", text_color=pos == 1 ? color.green : color.red, text_size=size.small)

    table.cell(info_table, 0, 6, "SL / TP", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 6, str.tostring(sl_pct) + "% / " + str.tostring(tp_pct) + "%", text_color=color.white, text_size=size.small)

    table.cell(info_table, 0, 7, "RR Ratio", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 7, "1:" + str.tostring(tp_pct / sl_pct, "#.#"), text_color=color.yellow, text_size=size.small)

    table.cell(info_table, 0, 8, "Risk", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 8, str.tostring(risk_pct) + "%", text_color=color.yellow, text_size=size.small)

    table.cell(info_table, 0, 9, "nLoss", text_color=color.gray, text_size=size.small)
    table.cell(info_table, 1, 9, "$" + str.tostring(nLoss, "#.##"), text_color=color.white, text_size=size.small)
