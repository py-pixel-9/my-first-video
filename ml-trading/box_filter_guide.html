<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Box Range Filter Guide - ATR + ADX + BBW</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    background: #0a0e17;
    color: #e6edf3;
    font-family: 'Segoe UI', -apple-system, sans-serif;
    line-height: 1.7;
    padding: 40px 20px;
  }
  .container { max-width: 1200px; margin: 0 auto; }

  h1 {
    text-align: center;
    font-size: 2.2em;
    background: linear-gradient(135deg, #26a69a, #42a5f5);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 10px;
  }
  .subtitle {
    text-align: center;
    color: #787b86;
    font-size: 1.1em;
    margin-bottom: 50px;
  }

  /* Section */
  .section {
    background: #131722;
    border: 1px solid #1e222d;
    border-radius: 16px;
    padding: 40px;
    margin-bottom: 30px;
    position: relative;
    overflow: hidden;
  }
  .section::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 3px;
  }
  .section.atr::before { background: linear-gradient(90deg, #26a69a, #26a69a00); }
  .section.adx::before { background: linear-gradient(90deg, #42a5f5, #42a5f500); }
  .section.bbw::before { background: linear-gradient(90deg, #ffa726, #ffa72600); }
  .section.combo::before { background: linear-gradient(90deg, #ab47bc, #ef5350, #ffa726); }

  .section-num {
    position: absolute;
    top: 20px; right: 30px;
    font-size: 4em;
    font-weight: 900;
    opacity: 0.06;
    color: #fff;
  }

  h2 {
    font-size: 1.6em;
    margin-bottom: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
  }
  h2 .badge {
    font-size: 0.45em;
    padding: 4px 12px;
    border-radius: 20px;
    font-weight: 600;
    vertical-align: middle;
  }
  .badge.green { background: #26a69a33; color: #26a69a; }
  .badge.blue { background: #42a5f533; color: #42a5f5; }
  .badge.orange { background: #ffa72633; color: #ffa726; }
  .badge.purple { background: #ab47bc33; color: #ab47bc; }

  h3 {
    color: #787b86;
    font-size: 1em;
    font-weight: 400;
    margin-bottom: 25px;
  }

  /* Formula box */
  .formula {
    background: #1a1f2e;
    border: 1px solid #2a3040;
    border-radius: 12px;
    padding: 20px 25px;
    margin: 20px 0;
    font-family: 'Consolas', 'Courier New', monospace;
    font-size: 1.05em;
    position: relative;
  }
  .formula .label {
    position: absolute;
    top: -10px; left: 15px;
    background: #1a1f2e;
    padding: 0 8px;
    font-size: 0.75em;
    color: #787b86;
    font-family: 'Segoe UI', sans-serif;
  }
  .formula .green { color: #26a69a; }
  .formula .red { color: #ef5350; }
  .formula .blue { color: #42a5f5; }
  .formula .yellow { color: #ffa726; }
  .formula .purple { color: #ab47bc; }

  /* Chart canvas area */
  .chart-area {
    background: #0d1117;
    border: 1px solid #1e222d;
    border-radius: 12px;
    padding: 20px;
    margin: 25px 0;
    position: relative;
  }
  .chart-area canvas {
    width: 100%;
    display: block;
  }

  /* Explanation grid */
  .explain-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 25px 0;
  }
  @media (max-width: 768px) {
    .explain-grid { grid-template-columns: 1fr; }
  }
  .explain-card {
    background: #1a1f2e;
    border-radius: 12px;
    padding: 20px;
    border: 1px solid #2a3040;
  }
  .explain-card h4 {
    font-size: 1em;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  .explain-card p { color: #9ca3af; font-size: 0.95em; }

  /* Status indicator */
  .status-row {
    display: flex;
    align-items: center;
    gap: 15px;
    padding: 12px 20px;
    background: #1a1f2e;
    border-radius: 10px;
    margin: 8px 0;
  }
  .status-dot {
    width: 12px; height: 12px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .status-dot.on { background: #26a69a; box-shadow: 0 0 8px #26a69a88; }
  .status-dot.off { background: #ef5350; box-shadow: 0 0 8px #ef535088; }
  .status-dot.warn { background: #ffa726; box-shadow: 0 0 8px #ffa72688; }

  /* Comparison table */
  .comp-table {
    width: 100%;
    border-collapse: collapse;
    margin: 20px 0;
  }
  .comp-table th {
    background: #1a1f2e;
    padding: 12px 16px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #2a3040;
    font-size: 0.9em;
  }
  .comp-table td {
    padding: 12px 16px;
    border-bottom: 1px solid #1e222d;
    font-size: 0.95em;
  }
  .comp-table tr:hover td { background: #1a1f2e44; }

  .tag {
    display: inline-block;
    padding: 2px 10px;
    border-radius: 6px;
    font-size: 0.85em;
    font-weight: 600;
  }
  .tag.on { background: #26a69a22; color: #26a69a; }
  .tag.off { background: #ef535022; color: #ef5350; }

  /* Interactive demo */
  .demo-panel {
    background: #1a1f2e;
    border: 1px solid #2a3040;
    border-radius: 12px;
    padding: 25px;
    margin: 25px 0;
  }
  .slider-group {
    margin: 15px 0;
  }
  .slider-group label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 0.95em;
  }
  .slider-group label span { color: #787b86; }
  .slider-group label .val {
    color: #42a5f5;
    font-weight: 600;
    font-family: 'Consolas', monospace;
  }
  input[type="range"] {
    width: 100%;
    height: 6px;
    -webkit-appearance: none;
    background: #2a3040;
    border-radius: 3px;
    outline: none;
  }
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 18px; height: 18px;
    border-radius: 50%;
    background: #42a5f5;
    cursor: pointer;
  }

  .result-box {
    text-align: center;
    padding: 25px;
    border-radius: 12px;
    margin-top: 20px;
    font-size: 1.4em;
    font-weight: 700;
    transition: all 0.3s;
  }
  .result-box.on {
    background: #26a69a15;
    border: 2px solid #26a69a;
    color: #26a69a;
  }
  .result-box.off {
    background: #ef535015;
    border: 2px solid #ef5350;
    color: #ef5350;
  }
  .result-box .sub {
    font-size: 0.5em;
    font-weight: 400;
    color: #787b86;
    display: block;
    margin-top: 5px;
  }

  /* Flow diagram */
  .flow {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0;
    margin: 30px 0;
    flex-wrap: wrap;
  }
  .flow-box {
    background: #1a1f2e;
    border: 2px solid #2a3040;
    border-radius: 12px;
    padding: 15px 22px;
    text-align: center;
    min-width: 150px;
  }
  .flow-box.highlight { border-color: #26a69a; background: #26a69a10; }
  .flow-box .title { font-weight: 700; font-size: 1em; }
  .flow-box .desc { color: #787b86; font-size: 0.8em; margin-top: 4px; }
  .flow-arrow {
    font-size: 1.5em;
    color: #787b86;
    padding: 0 8px;
  }

  .highlight-text { color: #26a69a; font-weight: 600; }
  .danger-text { color: #ef5350; font-weight: 600; }
  .warn-text { color: #ffa726; font-weight: 600; }
  .info-text { color: #42a5f5; font-weight: 600; }

  .note-box {
    background: #42a5f510;
    border-left: 3px solid #42a5f5;
    padding: 15px 20px;
    border-radius: 0 8px 8px 0;
    margin: 20px 0;
    font-size: 0.95em;
  }
  .warn-box {
    background: #ef535010;
    border-left: 3px solid #ef5350;
    padding: 15px 20px;
    border-radius: 0 8px 8px 0;
    margin: 20px 0;
  }

  .divider {
    height: 1px;
    background: linear-gradient(90deg, transparent, #363c4e, transparent);
    margin: 40px 0;
  }
</style>
</head>
<body>
<div class="container">

<h1>Box Range Filter System</h1>
<p class="subtitle">ATR + ADX + BBW  |  3-Filter Voting System for Breakout EA</p>

<!-- ============================================================ -->
<!-- OVERVIEW -->
<!-- ============================================================ -->
<div class="section combo">
  <div class="section-num">0</div>
  <h2>
    핵심 개념
    <span class="badge purple">Overview</span>
  </h2>
  <h3>왜 이 필터가 필요한가?</h3>

  <div class="explain-grid">
    <div class="explain-card">
      <h4><span style="color:#26a69a">&#9650;</span> 추세 구간 (파랑선)</h4>
      <p>가격이 방향성 있게 움직임<br>
      돌파 시 힘이 있어서 <span class="highlight-text">지지/저항을 뚫고 감</span><br>
      5분봉 돌파매매 = 수익</p>
    </div>
    <div class="explain-card">
      <h4><span style="color:#ef5350">&#9660;</span> 박스권 구간 (빨강선)</h4>
      <p>가격이 좁은 범위에 갇힘<br>
      돌파해도 힘이 없어서 <span class="danger-text">다시 되돌아옴</span><br>
      5분봉 돌파매매 = 연속 손절</p>
    </div>
  </div>

  <div class="flow">
    <div class="flow-box">
      <div class="title">5분봉 돌파 시그널</div>
      <div class="desc">기존 EA 로직</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-box highlight">
      <div class="title" style="color:#ffa726;">HTF 필터 검증</div>
      <div class="desc">1H 기준 3개 필터</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-box">
      <div class="title">2/3 통과?</div>
      <div class="desc">과반수 투표</div>
    </div>
    <div class="flow-arrow">&#8594;</div>
    <div class="flow-box" style="border-color:#26a69a;">
      <div class="title" style="color:#26a69a;">EA ON / OFF</div>
      <div class="desc">매매 허용 or 대기</div>
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- FILTER 1: ATR -->
<!-- ============================================================ -->
<div class="section atr">
  <div class="section-num">1</div>
  <h2>
    Filter 1: ATR (Average True Range)
    <span class="badge green">변동성 크기</span>
  </h2>
  <h3>"지금 시장이 얼마나 움직이고 있나?" 를 측정</h3>

  <div class="formula">
    <div class="label">공식</div>
    <span class="green">ATR(14)</span> &gt; <span class="blue">SMA( ATR(14), 50 )</span> &times; <span class="yellow">0.75</span>
  </div>

  <div class="explain-grid">
    <div class="explain-card">
      <h4 style="color:#26a69a;">ATR(14) 란?</h4>
      <p>최근 <strong>14개 봉</strong>의 평균 움직임 폭<br><br>
      각 봉에서 아래 3개 중 <strong>가장 큰 값</strong>을 구해요:<br>
      &bull; High - Low (봉 자체 범위)<br>
      &bull; |High - 이전Close| (갭업 포함)<br>
      &bull; |Low - 이전Close| (갭다운 포함)<br><br>
      그 14개의 평균 = <strong>ATR</strong></p>
    </div>
    <div class="explain-card">
      <h4 style="color:#42a5f5;">SMA(ATR, 50) 이란?</h4>
      <p>ATR 값의 <strong>50봉 단순이동평균</strong><br><br>
      = "최근 50시간(1H 기준) 동안의 <strong>평균적인 변동성</strong>"<br><br>
      이걸 <strong>기준선</strong>으로 삼아서<br>
      현재 ATR이 평균보다 높은지/낮은지 비교해요</p>
    </div>
  </div>

  <div class="chart-area">
    <canvas id="atrChart" height="300"></canvas>
  </div>

  <div class="status-row">
    <div class="status-dot on"></div>
    <div><strong>ON</strong>: ATR이 평균의 75% 이상 &rarr; "변동성 충분, 돌파하면 힘이 있음"</div>
  </div>
  <div class="status-row">
    <div class="status-dot off"></div>
    <div><strong>OFF</strong>: ATR이 평균의 75% 미만 &rarr; "변동성 부족, 돌파해도 힘 없음"</div>
  </div>

  <div class="note-box">
    <strong>XAUUSD 예시:</strong> 추세 구간에서 1H ATR이 $8~12 수준이었다면,
    빨강선 박스권에서는 $3~5로 급감했을 거예요. 평균 ATR의 75%에도 못 미치면 &rarr; EA OFF
  </div>
</div>

<!-- ============================================================ -->
<!-- FILTER 2: ADX -->
<!-- ============================================================ -->
<div class="section adx">
  <div class="section-num">2</div>
  <h2>
    Filter 2: ADX (Average Directional Index)
    <span class="badge blue">추세 강도</span>
  </h2>
  <h3>"추세가 있긴 한 건가?" 를 측정 (방향은 안 봄, 강도만)</h3>

  <div class="formula">
    <div class="label">공식</div>
    <span class="blue">ADX(14)</span> &gt; <span class="yellow">18</span>
  </div>

  <div class="explain-grid">
    <div class="explain-card">
      <h4 style="color:#42a5f5;">ADX 란?</h4>
      <p>0 ~ 100 사이 값으로 <strong>추세의 강도</strong>를 표현<br><br>
      &bull; <span class="danger-text">0~15</span>: 추세 없음 (횡보)<br>
      &bull; <span class="warn-text">15~25</span>: 약한 추세<br>
      &bull; <span class="highlight-text">25~50</span>: 강한 추세<br>
      &bull; <span class="info-text">50+</span>: 매우 강한 추세<br><br>
      <strong>방향은 안 알려줘요!</strong><br>
      상승이든 하락이든 추세가 있으면 ADX 상승</p>
    </div>
    <div class="explain-card">
      <h4 style="color:#ffa726;">+DI / -DI 란?</h4>
      <p>ADX의 <strong>구성 요소</strong>:<br><br>
      &bull; <span class="highlight-text">+DI</span>: 상승 방향 강도<br>
      &bull; <span class="danger-text">-DI</span>: 하락 방향 강도<br><br>
      +DI &gt; -DI = 상승 추세<br>
      -DI &gt; +DI = 하락 추세<br>
      +DI &cong; -DI = <strong>방향성 없음 (횡보)</strong><br><br>
      ADX는 이 두 DI의 <strong>차이를 평활화</strong>한 값</p>
    </div>
  </div>

  <div class="chart-area">
    <canvas id="adxChart" height="280"></canvas>
  </div>

  <table class="comp-table">
    <tr>
      <th>ADX 값</th>
      <th>시장 상태</th>
      <th>돌파매매</th>
      <th>EA</th>
    </tr>
    <tr>
      <td><span class="danger-text">0 ~ 15</span></td>
      <td>횡보 / 무방향</td>
      <td>돌파 실패 연속</td>
      <td><span class="tag off">OFF</span></td>
    </tr>
    <tr>
      <td><span class="warn-text">15 ~ 18</span></td>
      <td>약한 횡보</td>
      <td>불안정</td>
      <td><span class="tag off">OFF</span></td>
    </tr>
    <tr>
      <td><span class="highlight-text">18 ~ 25</span></td>
      <td>추세 시작</td>
      <td>돌파 시도 가능</td>
      <td><span class="tag on">ON</span></td>
    </tr>
    <tr>
      <td><span class="info-text">25+</span></td>
      <td>강한 추세</td>
      <td>돌파 성공률 높음</td>
      <td><span class="tag on">ON</span></td>
    </tr>
  </table>

  <div class="note-box">
    <strong>왜 18인가?</strong> 일반적으로 ADX 20~25을 기준으로 쓰지만,
    돌파매매는 "추세 시작 초기"에 진입하므로 살짝 낮춘 18이 적합해요.
    20으로 하면 추세 초입을 놓칠 수 있어요.
  </div>
</div>

<!-- ============================================================ -->
<!-- FILTER 3: BBW -->
<!-- ============================================================ -->
<div class="section bbw">
  <div class="section-num">3</div>
  <h2>
    Filter 3: BBW (Bollinger Band Width)
    <span class="badge orange">밴드 스퀴즈</span>
  </h2>
  <h3>"볼린저밴드가 좁아졌나?" = 박스권 직접 감지</h3>

  <div class="formula">
    <div class="label">공식</div>
    <span class="yellow">BBW</span> = ( <span class="green">Upper Band</span> - <span class="red">Lower Band</span> ) / <span class="blue">Middle Band</span> &times; 100
    <br><br>
    <span class="yellow">BBW</span> &gt; <span class="blue">SMA( BBW, 50 )</span> &times; <span class="yellow">0.65</span>
  </div>

  <div class="explain-grid">
    <div class="explain-card">
      <h4 style="color:#ffa726;">볼린저밴드 (BB) 기초</h4>
      <p><strong>Middle</strong> = SMA(20) = 20봉 이동평균<br>
      <strong>Upper</strong> = Middle + 2 &times; StdDev(20)<br>
      <strong>Lower</strong> = Middle - 2 &times; StdDev(20)<br><br>
      &bull; 밴드가 <strong>넓으면</strong> = 변동성 큼 = 추세<br>
      &bull; 밴드가 <strong>좁으면</strong> = 변동성 작음 = <span class="danger-text">박스권</span></p>
    </div>
    <div class="explain-card">
      <h4 style="color:#ffa726;">BBW (Band Width) 란?</h4>
      <p>밴드의 <strong>폭을 숫자로</strong> 표현한 것<br><br>
      BBW = (Upper - Lower) / Middle &times; 100<br><br>
      &bull; BBW <span class="danger-text">낮으면</span> = 스퀴즈 = 박스권<br>
      &bull; BBW <span class="highlight-text">높으면</span> = 확장 = 추세 진행<br><br>
      이 값을 50봉 평균과 비교해서<br>
      평균의 65% 이하면 <strong>"스퀴즈 상태"</strong></p>
    </div>
  </div>

  <div class="chart-area">
    <canvas id="bbwChart" height="320"></canvas>
  </div>

  <div class="status-row">
    <div class="status-dot on"></div>
    <div><strong>ON</strong>: BBW가 평균의 65% 이상 &rarr; "밴드 충분히 넓음, 움직일 공간 있음"</div>
  </div>
  <div class="status-row">
    <div class="status-dot off"></div>
    <div><strong>OFF</strong>: BBW가 평균의 65% 미만 &rarr; "스퀴즈! 박스권에 갇힘, 돌파 힘 없음"</div>
  </div>

  <div class="note-box">
    <strong>ATR vs BBW 차이:</strong> ATR은 봉 하나하나의 움직임 크기,
    BBW는 가격이 얼마나 넓은 범위에 분포하는지를 봐요.
    ATR이 일시적으로 클 수 있지만 BBW는 더 안정적으로 박스권을 감지해요.
  </div>
</div>

<!-- ============================================================ -->
<!-- COMBINATION: 투표 시스템 -->
<!-- ============================================================ -->
<div class="section combo">
  <div class="section-num">!</div>
  <h2>
    3-Filter 과반수 투표 시스템
    <span class="badge purple">Core Logic</span>
  </h2>
  <h3>3개 필터 중 2개 이상 통과해야 EA ON</h3>

  <div class="formula">
    <div class="label">최종 판정</div>
    <span class="purple">score</span> =
    (<span class="green">ATR 통과</span> ? 1 : 0) +
    (<span class="blue">ADX 통과</span> ? 1 : 0) +
    (<span class="yellow">BBW 통과</span> ? 1 : 0)
    <br><br>
    EA = <span class="purple">score</span> &ge; <span class="yellow">2</span> ? <span class="green">ON</span> : <span class="red">OFF</span>
  </div>

  <div class="explain-grid">
    <div class="explain-card">
      <h4>왜 "전부 통과" 가 아닌 "2/3"?</h4>
      <p>"3개 전부 통과"로 하면 너무 엄격해서
      <span class="danger-text">매매 기회가 극도로 줄어요</span>.<br><br>
      반대로 "1개만 통과"로 하면
      <span class="danger-text">박스권 필터링이 안 돼요</span>.<br><br>
      <strong>2/3 과반수</strong>가 최적의 밸런스!</p>
    </div>
    <div class="explain-card">
      <h4>왜 3개를 조합하나?</h4>
      <p>각 필터가 보는 관점이 달라요:<br><br>
      &bull; <span class="highlight-text">ATR</span>: 봉의 크기 (변동성)<br>
      &bull; <span class="info-text">ADX</span>: 추세 강도 (방향성)<br>
      &bull; <span class="warn-text">BBW</span>: 가격 분포 (밴드 폭)<br><br>
      <strong>다른 관점</strong>에서 같은 결론 =<br>
      신뢰도가 매우 높아요</p>
    </div>
  </div>

  <table class="comp-table">
    <tr>
      <th>시나리오</th>
      <th>ATR</th>
      <th>ADX</th>
      <th>BBW</th>
      <th>점수</th>
      <th>EA</th>
    </tr>
    <tr>
      <td>강한 상승 추세 (파랑선 구간)</td>
      <td><span class="tag on">PASS</span></td>
      <td><span class="tag on">PASS</span></td>
      <td><span class="tag on">PASS</span></td>
      <td>3/3</td>
      <td><span class="tag on">ON</span></td>
    </tr>
    <tr>
      <td>추세 초기 (변동성은 아직 낮음)</td>
      <td><span class="tag off">FAIL</span></td>
      <td><span class="tag on">PASS</span></td>
      <td><span class="tag on">PASS</span></td>
      <td>2/3</td>
      <td><span class="tag on">ON</span></td>
    </tr>
    <tr>
      <td>일시적 변동성 (뉴스 스파이크)</td>
      <td><span class="tag on">PASS</span></td>
      <td><span class="tag off">FAIL</span></td>
      <td><span class="tag off">FAIL</span></td>
      <td>1/3</td>
      <td><span class="tag off">OFF</span></td>
    </tr>
    <tr>
      <td style="color:#ef5350;font-weight:600;">박스권 횡보 (빨강선 구간)</td>
      <td><span class="tag off">FAIL</span></td>
      <td><span class="tag off">FAIL</span></td>
      <td><span class="tag off">FAIL</span></td>
      <td>0/3</td>
      <td><span class="tag off">OFF</span></td>
    </tr>
    <tr>
      <td>넓은 횡보 (큰 범위 왔다갔다)</td>
      <td><span class="tag on">PASS</span></td>
      <td><span class="tag off">FAIL</span></td>
      <td><span class="tag on">PASS</span></td>
      <td>2/3</td>
      <td><span class="tag on">ON</span></td>
    </tr>
  </table>

  <div class="warn-box">
    <strong>마지막 행 "넓은 횡보"에 주목!</strong><br>
    "횡보인데도 EA ON" &mdash; 이게 바로 유저님이 원하는 거예요!<br>
    횡보 자체가 문제가 아니라, <strong>좁은 박스권</strong>이 문제니까.<br>
    넓은 범위로 왔다갔다하면 돌파매매가 먹히거든요.
  </div>
</div>

<!-- ============================================================ -->
<!-- INTERACTIVE DEMO -->
<!-- ============================================================ -->
<div class="section combo">
  <div class="section-num">&#9881;</div>
  <h2>
    Interactive Demo
    <span class="badge purple">직접 테스트</span>
  </h2>
  <h3>슬라이더를 움직여서 각 필터의 ON/OFF를 확인해보세요</h3>

  <div class="demo-panel">
    <div class="slider-group">
      <label>
        <span>ATR(14) 현재값</span>
        <span class="val" id="atr-val">6.0</span>
      </label>
      <input type="range" id="atr-slider" min="0" max="15" step="0.1" value="6">
    </div>
    <div class="slider-group">
      <label>
        <span>ATR 50봉 평균</span>
        <span class="val" id="atr-avg-val">8.0</span>
      </label>
      <input type="range" id="atr-avg-slider" min="1" max="15" step="0.1" value="8">
    </div>

    <div style="height:1px;background:#2a3040;margin:20px 0;"></div>

    <div class="slider-group">
      <label>
        <span>ADX(14) 현재값</span>
        <span class="val" id="adx-val">22</span>
      </label>
      <input type="range" id="adx-slider" min="0" max="60" step="1" value="22">
    </div>

    <div style="height:1px;background:#2a3040;margin:20px 0;"></div>

    <div class="slider-group">
      <label>
        <span>BBW 현재값</span>
        <span class="val" id="bbw-val">3.5</span>
      </label>
      <input type="range" id="bbw-slider" min="0" max="10" step="0.1" value="3.5">
    </div>
    <div class="slider-group">
      <label>
        <span>BBW 50봉 평균</span>
        <span class="val" id="bbw-avg-val">5.0</span>
      </label>
      <input type="range" id="bbw-avg-slider" min="0.5" max="10" step="0.1" value="5">
    </div>

    <!-- Filter status -->
    <div style="margin-top:25px;">
      <div class="status-row" id="f1-status">
        <div class="status-dot" id="f1-dot"></div>
        <div id="f1-text">ATR: 계산중...</div>
      </div>
      <div class="status-row" id="f2-status">
        <div class="status-dot" id="f2-dot"></div>
        <div id="f2-text">ADX: 계산중...</div>
      </div>
      <div class="status-row" id="f3-status">
        <div class="status-dot" id="f3-dot"></div>
        <div id="f3-text">BBW: 계산중...</div>
      </div>
    </div>

    <div class="result-box" id="final-result">
      계산중...
    </div>
  </div>
</div>

<!-- ============================================================ -->
<!-- XAUUSD 적용 요약 -->
<!-- ============================================================ -->
<div class="section atr">
  <div class="section-num">&#10003;</div>
  <h2>
    XAUUSD EA 적용 요약
    <span class="badge green">Implementation</span>
  </h2>
  <h3>5분봉 돌파매매 + 1H 필터 적용 방법</h3>

  <div class="formula">
    <div class="label">MQL5 Pseudo Code</div>
    <span class="blue">// 1H 타임프레임에서 필터 계산</span><br>
    <span class="green">double atr14</span> = iATR(_Symbol, PERIOD_H1, 14);<br>
    <span class="green">double atr_avg</span> = SMA(atr14_buffer, 50);<br>
    <span class="blue">double adx14</span> = iADX(_Symbol, PERIOD_H1, 14);<br>
    <span class="yellow">double bbw</span> = (bb_upper - bb_lower) / bb_middle * 100;<br>
    <span class="yellow">double bbw_avg</span> = SMA(bbw_buffer, 50);<br>
    <br>
    <span class="purple">int score</span> = 0;<br>
    if (<span class="green">atr14</span> > <span class="green">atr_avg</span> * 0.75) <span class="purple">score</span>++;<br>
    if (<span class="blue">adx14</span> > 18) <span class="purple">score</span>++;<br>
    if (<span class="yellow">bbw</span> > <span class="yellow">bbw_avg</span> * 0.65) <span class="purple">score</span>++;<br>
    <br>
    <span class="purple">bool ea_allowed</span> = (<span class="purple">score</span> >= 2);
  </div>

  <table class="comp-table">
    <tr>
      <th>설정</th>
      <th>값</th>
      <th>설명</th>
    </tr>
    <tr>
      <td>매매 타임프레임</td>
      <td><strong>M5</strong> (5분)</td>
      <td>기존 돌파매매 로직</td>
    </tr>
    <tr>
      <td>필터 타임프레임</td>
      <td><strong>H1</strong> (1시간)</td>
      <td>더 큰 그림으로 시장 상태 판단</td>
    </tr>
    <tr>
      <td>ATR 기간</td>
      <td>14</td>
      <td>14시간(1H) 변동성</td>
    </tr>
    <tr>
      <td>ATR 평균 기간</td>
      <td>50</td>
      <td>50시간(~2일) 평균 변동성</td>
    </tr>
    <tr>
      <td>ATR 임계값</td>
      <td>&times; 0.75</td>
      <td>평균의 75% 이상이면 통과</td>
    </tr>
    <tr>
      <td>ADX 기간</td>
      <td>14</td>
      <td>표준 설정</td>
    </tr>
    <tr>
      <td>ADX 임계값</td>
      <td>&gt; 18</td>
      <td>추세 초기부터 감지</td>
    </tr>
    <tr>
      <td>BB 기간</td>
      <td>20, StdDev 2</td>
      <td>표준 볼린저밴드</td>
    </tr>
    <tr>
      <td>BBW 평균 기간</td>
      <td>50</td>
      <td>50시간 평균 밴드폭</td>
    </tr>
    <tr>
      <td>BBW 임계값</td>
      <td>&times; 0.65</td>
      <td>평균의 65% 이상이면 통과</td>
    </tr>
    <tr>
      <td>투표 기준</td>
      <td>&ge; 2/3</td>
      <td>과반수 통과시 매매 허용</td>
    </tr>
  </table>
</div>

</div><!-- container -->

<script>
// ============================================================
// Interactive Demo Logic
// ============================================================
function updateDemo() {
  const atr = parseFloat(document.getElementById('atr-slider').value);
  const atrAvg = parseFloat(document.getElementById('atr-avg-slider').value);
  const adx = parseFloat(document.getElementById('adx-slider').value);
  const bbw = parseFloat(document.getElementById('bbw-slider').value);
  const bbwAvg = parseFloat(document.getElementById('bbw-avg-slider').value);

  document.getElementById('atr-val').textContent = atr.toFixed(1);
  document.getElementById('atr-avg-val').textContent = atrAvg.toFixed(1);
  document.getElementById('adx-val').textContent = adx.toFixed(0);
  document.getElementById('bbw-val').textContent = bbw.toFixed(1);
  document.getElementById('bbw-avg-val').textContent = bbwAvg.toFixed(1);

  // Filter 1: ATR
  const f1 = atr > atrAvg * 0.75;
  const f1Threshold = (atrAvg * 0.75).toFixed(1);
  document.getElementById('f1-dot').className = `status-dot ${f1 ? 'on' : 'off'}`;
  document.getElementById('f1-text').innerHTML =
    `<strong>ATR:</strong> ${atr.toFixed(1)} ${f1 ? '>' : '<='} ${f1Threshold} (avg ${atrAvg.toFixed(1)} x 0.75) → <strong style="color:${f1?'#26a69a':'#ef5350'}">${f1?'PASS':'FAIL'}</strong>`;

  // Filter 2: ADX
  const f2 = adx > 18;
  document.getElementById('f2-dot').className = `status-dot ${f2 ? 'on' : 'off'}`;
  document.getElementById('f2-text').innerHTML =
    `<strong>ADX:</strong> ${adx.toFixed(0)} ${f2 ? '>' : '<='} 18 → <strong style="color:${f2?'#26a69a':'#ef5350'}">${f2?'PASS':'FAIL'}</strong>`;

  // Filter 3: BBW
  const f3 = bbw > bbwAvg * 0.65;
  const f3Threshold = (bbwAvg * 0.65).toFixed(1);
  document.getElementById('f3-dot').className = `status-dot ${f3 ? 'on' : 'off'}`;
  document.getElementById('f3-text').innerHTML =
    `<strong>BBW:</strong> ${bbw.toFixed(1)} ${f3 ? '>' : '<='} ${f3Threshold} (avg ${bbwAvg.toFixed(1)} x 0.65) → <strong style="color:${f3?'#26a69a':'#ef5350'}">${f3?'PASS':'FAIL'}</strong>`;

  // Final result
  const score = (f1?1:0) + (f2?1:0) + (f3?1:0);
  const on = score >= 2;
  const rb = document.getElementById('final-result');
  rb.className = `result-box ${on ? 'on' : 'off'}`;
  rb.innerHTML = on
    ? `EA ON (${score}/3 통과)<span class="sub">매매 허용 - 돌파 시그널 실행</span>`
    : `EA OFF (${score}/3 통과)<span class="sub">매매 중지 - 박스권 감지됨</span>`;
}

['atr-slider','atr-avg-slider','adx-slider','bbw-slider','bbw-avg-slider'].forEach(id => {
  document.getElementById(id).addEventListener('input', updateDemo);
});
updateDemo();

// ============================================================
// Chart Drawings
// ============================================================
function drawATRChart() {
  const canvas = document.getElementById('atrChart');
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2;
  const H = canvas.height = 600;
  ctx.scale(1, 1);

  ctx.fillStyle = '#0d1117';
  ctx.fillRect(0, 0, W, H);

  // Simulated ATR data
  const data = [];
  let v = 8;
  for(let i = 0; i < 120; i++) {
    if(i < 40) v = 7 + Math.random() * 5;       // trend
    else if(i < 50) v = Math.max(2, v - 0.4 + Math.random() * 0.3);  // declining
    else if(i < 85) v = 2 + Math.random() * 2;   // box range
    else if(i < 95) v = v + 0.3 + Math.random() * 0.5;  // recovering
    else v = 6 + Math.random() * 5;               // trend again
    data.push(v);
  }

  // SMA 50
  const sma = [];
  for(let i = 0; i < data.length; i++) {
    const start = Math.max(0, i - 49);
    const slice = data.slice(start, i + 1);
    sma.push(slice.reduce((a,b)=>a+b) / slice.length);
  }

  const padL = 50, padR = 30, padT = 40, padB = 50;
  const cW = W - padL - padR;
  const cH = H - padT - padB;
  const maxV = 15;

  function x(i) { return padL + (i / (data.length - 1)) * cW; }
  function y(v) { return padT + (1 - v / maxV) * cH; }

  // Background zones
  // Box range zone
  ctx.fillStyle = '#ef535012';
  ctx.fillRect(x(50), padT, x(85) - x(50), cH);
  ctx.fillStyle = '#ef535060';
  ctx.font = '22px Segoe UI';
  ctx.textAlign = 'center';
  ctx.fillText('Box Range (ATR Low)', (x(50) + x(85)) / 2, padT + 30);

  // Trend zones
  ctx.fillStyle = '#26a69a08';
  ctx.fillRect(x(0), padT, x(40) - x(0), cH);
  ctx.fillRect(x(95), padT, x(119) - x(95), cH);

  // Threshold line (SMA * 0.75)
  ctx.strokeStyle = '#ffa72666';
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 4]);
  ctx.beginPath();
  for(let i = 0; i < sma.length; i++) {
    const threshold = sma[i] * 0.75;
    if(i === 0) ctx.moveTo(x(i), y(threshold));
    else ctx.lineTo(x(i), y(threshold));
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // SMA line
  ctx.strokeStyle = '#42a5f5';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i = 0; i < sma.length; i++) {
    if(i === 0) ctx.moveTo(x(i), y(sma[i]));
    else ctx.lineTo(x(i), y(sma[i]));
  }
  ctx.stroke();

  // ATR line (colored by pass/fail)
  for(let i = 1; i < data.length; i++) {
    const pass = data[i] > sma[i] * 0.75;
    ctx.strokeStyle = pass ? '#26a69a' : '#ef5350';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x(i-1), y(data[i-1]));
    ctx.lineTo(x(i), y(data[i]));
    ctx.stroke();
  }

  // Labels
  ctx.fillStyle = '#26a69a';
  ctx.font = 'bold 20px Consolas';
  ctx.textAlign = 'left';
  ctx.fillText('ATR(14)', padL + 10, padT + 25);
  ctx.fillStyle = '#42a5f5';
  ctx.fillText('SMA(ATR, 50)', padL + 130, padT + 25);
  ctx.fillStyle = '#ffa726';
  ctx.fillText('Threshold (x0.75)', padL + 310, padT + 25);

  // Axis
  ctx.strokeStyle = '#363c4e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT); ctx.lineTo(padL, H - padB);
  ctx.lineTo(W - padR, H - padB);
  ctx.stroke();
}

function drawADXChart() {
  const canvas = document.getElementById('adxChart');
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2;
  const H = canvas.height = 560;

  ctx.fillStyle = '#0d1117';
  ctx.fillRect(0, 0, W, H);

  // Simulated ADX data
  const data = [];
  let v = 30;
  for(let i = 0; i < 120; i++) {
    if(i < 40) v = 25 + Math.random() * 15;      // strong trend
    else if(i < 55) v = Math.max(8, v - 0.8 + Math.random() * 0.3);
    else if(i < 85) v = 8 + Math.random() * 8;    // weak/no trend
    else if(i < 95) v = v + 0.5 + Math.random() * 0.5;
    else v = 22 + Math.random() * 15;
    data.push(Math.min(60, Math.max(5, v)));
  }

  const padL = 50, padR = 30, padT = 40, padB = 50;
  const cW = W - padL - padR;
  const cH = H - padT - padB;
  const maxV = 60;

  function x(i) { return padL + (i / (data.length - 1)) * cW; }
  function y(v) { return padT + (1 - v / maxV) * cH; }

  // Zones
  ctx.fillStyle = '#ef535012';
  ctx.fillRect(padL, y(18), cW, y(0) - y(18));
  ctx.fillStyle = '#26a69a08';
  ctx.fillRect(padL, y(60), cW, y(18) - y(60));

  // ADX = 18 threshold
  ctx.strokeStyle = '#ffa72666';
  ctx.lineWidth = 2;
  ctx.setLineDash([8, 4]);
  ctx.beginPath();
  ctx.moveTo(padL, y(18));
  ctx.lineTo(W - padR, y(18));
  ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle = '#ffa72688';
  ctx.font = '20px Segoe UI';
  ctx.textAlign = 'right';
  ctx.fillText('ADX = 18 (Threshold)', W - padR - 10, y(18) - 8);

  // Box range zone label
  ctx.fillStyle = '#ef535060';
  ctx.font = '22px Segoe UI';
  ctx.textAlign = 'center';
  ctx.fillText('Box Range (ADX < 18)', (x(55) + x(85)) / 2, y(5));

  // ADX line
  for(let i = 1; i < data.length; i++) {
    const pass = data[i] > 18;
    ctx.strokeStyle = pass ? '#42a5f5' : '#ef5350';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x(i-1), y(data[i-1]));
    ctx.lineTo(x(i), y(data[i]));
    ctx.stroke();
  }

  // Labels
  ctx.fillStyle = '#42a5f5';
  ctx.font = 'bold 20px Consolas';
  ctx.textAlign = 'left';
  ctx.fillText('ADX(14)', padL + 10, padT + 25);

  ctx.fillStyle = '#787b86';
  ctx.font = '16px Segoe UI';
  ctx.fillText('< 18: OFF (no trend)', padL + 10, H - padB + 35);
  ctx.fillStyle = '#42a5f5';
  ctx.fillText('> 18: ON (trend present)', padL + 230, H - padB + 35);

  // Axis
  ctx.strokeStyle = '#363c4e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, padT); ctx.lineTo(padL, H - padB);
  ctx.lineTo(W - padR, H - padB);
  ctx.stroke();
}

function drawBBWChart() {
  const canvas = document.getElementById('bbwChart');
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth * 2;
  const H = canvas.height = 640;

  ctx.fillStyle = '#0d1117';
  ctx.fillRect(0, 0, W, H);

  const half = H / 2;

  // === TOP: Price + Bollinger Bands ===
  const prices = [];
  let p = 2650;
  for(let i = 0; i < 120; i++) {
    if(i < 40) p += (Math.random() - 0.35) * 15;     // trending up
    else if(i < 55) p += (Math.random() - 0.5) * 8;   // slowing
    else if(i < 85) p += (Math.random() - 0.5) * 3;   // tight range
    else if(i < 95) p += (Math.random() - 0.3) * 10;   // breakout
    else p += (Math.random() - 0.35) * 15;
    prices.push(p);
  }

  // BB calculation
  const bbPeriod = 20, bbStd = 2;
  const upper = [], lower = [], middle = [], bbw = [];
  for(let i = 0; i < prices.length; i++) {
    const start = Math.max(0, i - bbPeriod + 1);
    const slice = prices.slice(start, i + 1);
    const avg = slice.reduce((a,b)=>a+b) / slice.length;
    const std = Math.sqrt(slice.reduce((s,v)=>s+(v-avg)**2, 0) / slice.length);
    middle.push(avg);
    upper.push(avg + bbStd * std);
    lower.push(avg - bbStd * std);
    bbw.push(avg > 0 ? ((avg + bbStd*std) - (avg - bbStd*std)) / avg * 100 : 0);
  }

  // BBW SMA
  const bbwSma = [];
  for(let i = 0; i < bbw.length; i++) {
    const s = Math.max(0, i - 49);
    const sl = bbw.slice(s, i + 1);
    bbwSma.push(sl.reduce((a,b)=>a+b) / sl.length);
  }

  const padL = 50, padR = 30, padT = 20, padB = 10;
  const topH = half - 20;
  const botY = half + 10;
  const botH = H - botY - 40;

  // Top chart scaling
  const pMin = Math.min(...lower) - 5;
  const pMax = Math.max(...upper) + 5;
  function x(i) { return padL + (i / 119) * (W - padL - padR); }
  function yTop(v) { return padT + (1 - (v - pMin) / (pMax - pMin)) * topH; }

  // Box zone bg
  ctx.fillStyle = '#ef535010';
  ctx.fillRect(x(55), padT, x(85) - x(55), topH);
  ctx.fillRect(x(55), botY, x(85) - x(55), botH);

  // BB bands fill
  ctx.fillStyle = '#42a5f508';
  ctx.beginPath();
  for(let i = 0; i < 120; i++) {
    if(i===0) ctx.moveTo(x(i), yTop(upper[i]));
    else ctx.lineTo(x(i), yTop(upper[i]));
  }
  for(let i = 119; i >= 0; i--) ctx.lineTo(x(i), yTop(lower[i]));
  ctx.closePath();
  ctx.fill();

  // Upper band
  ctx.strokeStyle = '#42a5f544';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  for(let i=0;i<120;i++){if(i===0)ctx.moveTo(x(i),yTop(upper[i]));else ctx.lineTo(x(i),yTop(upper[i]));}
  ctx.stroke();
  // Lower band
  ctx.beginPath();
  for(let i=0;i<120;i++){if(i===0)ctx.moveTo(x(i),yTop(lower[i]));else ctx.lineTo(x(i),yTop(lower[i]));}
  ctx.stroke();
  // Middle
  ctx.strokeStyle = '#42a5f566';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let i=0;i<120;i++){if(i===0)ctx.moveTo(x(i),yTop(middle[i]));else ctx.lineTo(x(i),yTop(middle[i]));}
  ctx.stroke();

  // Price line
  ctx.strokeStyle = '#e6edf3';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<120;i++){if(i===0)ctx.moveTo(x(i),yTop(prices[i]));else ctx.lineTo(x(i),yTop(prices[i]));}
  ctx.stroke();

  // Top labels
  ctx.fillStyle = '#e6edf3';
  ctx.font = 'bold 18px Consolas';
  ctx.textAlign = 'left';
  ctx.fillText('XAUUSD 1H + Bollinger Bands(20, 2)', padL + 10, padT + 20);

  ctx.fillStyle = '#ef535080';
  ctx.font = '20px Segoe UI';
  ctx.textAlign = 'center';
  ctx.fillText('Squeeze!', (x(55)+x(85))/2, padT + 45);

  // === BOTTOM: BBW chart ===
  const bMax = Math.max(...bbw) * 1.1;
  function yBot(v) { return botY + (1 - v / bMax) * botH; }

  // BBW threshold
  ctx.strokeStyle = '#ffa72644';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([6,3]);
  ctx.beginPath();
  for(let i=0;i<120;i++){
    const th = bbwSma[i]*0.65;
    if(i===0)ctx.moveTo(x(i),yBot(th));else ctx.lineTo(x(i),yBot(th));
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // BBW SMA
  ctx.strokeStyle = '#42a5f5';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  for(let i=0;i<120;i++){if(i===0)ctx.moveTo(x(i),yBot(bbwSma[i]));else ctx.lineTo(x(i),yBot(bbwSma[i]));}
  ctx.stroke();

  // BBW line colored
  for(let i=1;i<120;i++){
    const pass = bbw[i] > bbwSma[i]*0.65;
    ctx.strokeStyle = pass ? '#ffa726' : '#ef5350';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.moveTo(x(i-1),yBot(bbw[i-1]));
    ctx.lineTo(x(i),yBot(bbw[i]));
    ctx.stroke();
  }

  // Divider line
  ctx.strokeStyle = '#363c4e';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(padL, half);
  ctx.lineTo(W - padR, half);
  ctx.stroke();

  // Bot labels
  ctx.fillStyle = '#ffa726';
  ctx.font = 'bold 18px Consolas';
  ctx.textAlign = 'left';
  ctx.fillText('BBW (Band Width)', padL + 10, botY + 20);
  ctx.fillStyle = '#42a5f5';
  ctx.fillText('SMA(BBW,50)', padL + 230, botY + 20);
  ctx.fillStyle = '#ffa726';
  ctx.font = '14px Segoe UI';
  ctx.fillText('Threshold (x0.65)', padL + 410, botY + 20);
}

// Draw all charts
drawATRChart();
drawADXChart();
drawBBWChart();

// Redraw on resize
window.addEventListener('resize', () => {
  drawATRChart();
  drawADXChart();
  drawBBWChart();
});
</script>
</body>
</html>
